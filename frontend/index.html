<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pipeline Resilience Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #2a2a2a;
            padding-bottom: 1rem;
            text-align: center;
        }
        
        h1 {
            color: #ffffff;
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #B7B7B7;
            font-size: 0.9rem;
        }
        
        .status-container {
            margin-top: 1rem;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 0;
            margin-right: 8px;
            background: #73BF69;
        }
        
        .status-indicator.offline {
            background: #E24D42;
        }
        
        .refresh-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: #2a2a2a;
            border-radius: 4px;
        }
        
        .refresh-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-btn {
            background: #404040;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .toggle-btn.active {
            background: #73BF69;
        }
        
        .toggle-btn:hover {
            background: #505050;
        }
        
        .toggle-btn.active:hover {
            background: #5a9f59;
        }
        
        .interval-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .interval-control label {
            color: #B7B7B7;
            font-size: 14px;
        }
        
        .interval-slider {
            width: 120px;
            cursor: pointer;
        }
        
        .interval-value {
            color: #73BF69;
            font-weight: 600;
            min-width: 40px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-left: 4px solid #73BF69;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.2s;
        }
        
        .metric-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .metric-card.warning {
            border-left-color: #F79420;
        }
        
        .metric-card.critical {
            border-left-color: #E24D42;
        }
        
        .metric-card.emergency {
            border-left-color: #8B0000;
        }
        
        .metric-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #73BF69;
            margin: 12px 0;
            line-height: 1.2;
        }
        
        .metric-card.warning .metric-value {
            color: #F79420;
        }
        
        .metric-card.critical .metric-value {
            color: #E24D42;
        }
        
        .metric-card.emergency .metric-value {
            color: #8B0000;
        }
        
        .metric-status {
            font-size: 12px;
            color: #B7B7B7;
            margin-top: 8px;
        }
        
        .progress-bar {
            margin-top: 12px;
            height: 4px;
            background: #1a1a1a;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #73BF69;
            transition: width 0.3s;
        }
        
        .metric-card.warning .progress-fill {
            background: #F79420;
        }
        
        .metric-card.critical .progress-fill {
            background: #E24D42;
        }
        
        .metric-card.emergency .progress-fill {
            background: #8B0000;
        }
        
        .chart-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        
        .chart-section h3 {
            color: #ffffff;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .alerts-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #2a2a2a;
        }
        
        .alerts-section h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .alerts-summary {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .alert-count-badge {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .alert-count-badge.warning {
            background: rgba(247, 148, 32, 0.2);
            color: #F79420;
            border: 1px solid #F79420;
        }
        
        .alert-count-badge.critical {
            background: rgba(226, 77, 66, 0.2);
            color: #E24D42;
            border: 1px solid #E24D42;
        }
        
        .alert-count-badge.emergency {
            background: rgba(139, 0, 0, 0.2);
            color: #ff6666;
            border: 1px solid #8B0000;
        }
        
        .alert-panel {
            background: #1a1a1a;
            border-left: 4px solid;
            padding: 20px;
            margin: 12px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .alert-warning {
            border-left-color: #F79420;
        }
        
        .alert-critical {
            border-left-color: #E24D42;
        }
        
        .alert-emergency {
            border-left-color: #8B0000;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .alert-details {
            font-size: 14px;
            color: #B7B7B7;
        }
        
        .alert-detail-row {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .alert-detail-label {
            color: #B7B7B7;
            font-weight: 500;
        }
        
        .alert-detail-value {
            color: #e0e0e0;
            margin-left: 8px;
        }
        
        .alert-details-expanded {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
        }
        
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            cursor: pointer;
            color: #B7B7B7;
            font-size: 12px;
            border: 1px solid #404040;
            border-radius: 50%;
            text-align: center;
            line-height: 14px;
            vertical-align: middle;
        }
        
        .info-icon:hover {
            color: #ffffff;
            border-color: #73BF69;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-content {
            visibility: hidden;
            position: absolute;
            background: #2a2a2a;
            color: #e0e0e0;
            padding: 12px;
            border: 1px solid #404040;
            border-radius: 4px;
            z-index: 1000;
            width: 300px;
            font-size: 12px;
            line-height: 1.6;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip:hover .tooltip-content {
            visibility: visible;
        }
        
        .tooltip-content code {
            background: #1a1a1a;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }
        
        footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #2a2a2a;
            text-align: center;
            color: #B7B7B7;
            font-size: 14px;
        }
        
        footer a {
            color: #73BF69;
            text-decoration: none;
            margin: 0 8px;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #B7B7B7;
        }
        
        .error {
            background: #1a1a1a;
            border: 1px solid #E24D42;
            padding: 1rem;
            margin: 1rem 0;
            color: #E24D42;
        }
        
        .refresh-btn {
            background: #2a2a2a;
            color: white;
            border: 1px solid #404040;
            padding: 10px 20px;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .refresh-btn:hover {
            background: #3a3a3a;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #B7B7B7;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #ffffff;
            border-bottom-color: #73BF69;
        }
        
        .tab:hover {
            color: #ffffff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .timeline-event {
            display: flex;
            align-items: flex-start;
            margin: 1rem 0;
            padding-left: 20px;
            border-left: 2px solid #404040;
            position: relative;
        }
        
        .timeline-event::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #73BF69;
        }
        
        .timeline-event.warning::before {
            background: #F79420;
        }
        
        .timeline-event.critical::before {
            background: #E24D42;
        }
        
        .timeline-event.emergency::before {
            background: #8B0000;
        }
        
        .timeline-event.rollback::before {
            background: #5b9bd5;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-time {
            color: #B7B7B7;
            font-size: 12px;
            min-width: 140px;
        }
        
        .timeline-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .timeline-desc {
            font-size: 14px;
            color: #B7B7B7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Pipeline Resilience Dashboard</h1>
            <p class="subtitle">Drift Detection and Rollback System for Healthcare AI Pipelines</p>
            <div class="status-container">
                <span class="status-indicator" id="apiStatus"></span>
                <span id="apiStatusText">Checking API...</span>
            </div>
            
            <div class="refresh-controls">
                <div class="refresh-toggle">
                    <button class="toggle-btn active" id="refreshToggle" onclick="toggleAutoRefresh()">
                        Auto-Refresh: ON
                    </button>
                </div>
                <div class="interval-control">
                    <label>Interval:</label>
                    <input type="range" class="interval-slider" id="intervalSlider" 
                           min="30" max="60" value="30" step="5" 
                           onchange="updateInterval(this.value)">
                    <span class="interval-value" id="intervalValue">30s</span>
                </div>
                <button class="refresh-btn" onclick="loadData()" style="margin: 0; padding: 8px 16px;">
                    Refresh Now
                </button>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('drift')">Drift Detection</div>
            <div class="tab" onclick="switchTab('rollback')">Rollback Control</div>
            <div class="tab" onclick="switchTab('overview')">System Overview</div>
        </div>
        
        <div id="driftTab" class="tab-content active">
            <div id="metricsContainer" class="loading">Loading metrics...</div>
            <div class="charts-grid">
                <div class="chart-section">
                    <h3>Drift Metrics Over Time</h3>
                    <div id="driftChart" class="chart-container"></div>
                </div>
                <div class="chart-section">
                    <h3>Alert Timeline</h3>
                    <div id="alertChart" class="chart-container"></div>
                </div>
            </div>
            <div id="alertsContainer" class="alerts-section"></div>
        </div>
        
        <div id="rollbackTab" class="tab-content">
            <div id="rollbackContainer" class="loading">Loading rollback information...</div>
        </div>
        
        <div id="overviewTab" class="tab-content">
            <div id="overviewContainer" class="loading">Loading system overview...</div>
        </div>
        
        <footer>
            <a href="https://github.com/vasanthpanuganti/AI-voice-reliability-dashboard" target="_blank" rel="noopener noreferrer">GitHub</a>
            <span>|</span>
            <span>Built by curiosity</span>
        </footer>
    </div>
    
    <script>
        const API_BASE_URL = window.location.origin;
        let refreshInterval = null;
        let autoRefreshEnabled = true;
        let refreshIntervalMs = 30000;
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('refreshToggle');
            
            if (autoRefreshEnabled) {
                btn.textContent = 'Auto-Refresh: ON';
                btn.classList.add('active');
                startAutoRefresh();
            } else {
                btn.textContent = 'Auto-Refresh: OFF';
                btn.classList.remove('active');
                stopAutoRefresh();
            }
        }
        
        function updateInterval(value) {
            refreshIntervalMs = value * 1000;
            document.getElementById('intervalValue').textContent = value + 's';
            
            if (autoRefreshEnabled) {
                stopAutoRefresh();
                startAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadData, refreshIntervalMs);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            loadData();
        }
        
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                const statusEl = document.getElementById('apiStatus');
                const statusText = document.getElementById('apiStatusText');
                
                if (data.status === 'healthy') {
                    statusEl.classList.remove('offline');
                    statusText.textContent = 'API: Healthy';
                } else {
                    statusEl.classList.add('offline');
                    statusText.textContent = 'API: Offline';
                }
            } catch (error) {
                document.getElementById('apiStatus').classList.add('offline');
                document.getElementById('apiStatusText').textContent = 'API: Offline';
            }
        }
        
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }
        
        function getSeverityClass(severity) {
            const severityLower = severity?.toLowerCase() || 'normal';
            if (severityLower === 'warning') return 'warning';
            if (severityLower === 'critical') return 'critical';
            if (severityLower === 'emergency') return 'emergency';
            return '';
        }
        
        function formatMetricValue(value, metricType) {
            if (value === null || value === undefined) return 'N/A';
            if (metricType === 'psi_score' || metricType === 'js_divergence') {
                return value.toFixed(3);
            }
            if (metricType === 'ks_p_value') {
                return value.toExponential(2);
            }
            return value.toFixed(2);
        }
        
        function createMetricCard(label, value, severity, subtitle = '', progress = 0, metricType = '') {
            const severityClass = getSeverityClass(severity);
            const statusMap = {
                normal: 'All Good',
                warning: 'Needs Attention',
                critical: 'Action Required',
                emergency: 'Urgent Action'
            };
            
            const status = statusMap[severity?.toLowerCase() || 'normal'] || 'All Good';
            
            const formulas = {
                'psi_score': {
                    title: 'Population Stability Index (PSI)',
                    formula: 'PSI = Sum((Actual_i - Expected_i) x ln(Actual_i / Expected_i))',
                    description: 'Measures how much a distribution has shifted over time. Higher values indicate greater distribution change.'
                },
                'ks_p_value': {
                    title: 'Kolmogorov-Smirnov Test',
                    formula: 'D = max|F_n(x) - F_0(x)|',
                    description: 'Tests if two samples come from the same distribution. Lower p-values indicate distributions are more different.'
                },
                'js_divergence': {
                    title: 'Jensen-Shannon Divergence',
                    formula: 'JS(P||Q) = 0.5 x KL(P||M) + 0.5 x KL(Q||M)',
                    description: 'Symmetric measure of similarity between probability distributions. Returns value between 0 (identical) and 1 (completely different).'
                }
            };
            
            const formulaInfo = formulas[metricType] || null;
            const infoButton = formulaInfo ? `
                <span class="tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                        <strong>${formulaInfo.title}</strong><br><br>
                        <strong>Formula:</strong><br>
                        <code>${formulaInfo.formula}</code><br><br>
                        <strong>Interpretation:</strong><br>
                        ${formulaInfo.description}
                    </span>
                </span>
            ` : '';
            
            return `
                <div class="metric-card ${severityClass}">
                    <div class="metric-label">${label}${infoButton}</div>
                    <div class="metric-value">${value}</div>
                    <div class="metric-status">${status}</div>
                    ${subtitle ? `<div class="metric-status">${subtitle}</div>` : ''}
                    ${progress > 0 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(100, progress)}%"></div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        async function loadDriftMetrics() {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '<div class="loading">Loading metrics...</div>';
            
            const metrics = await fetchAPI('/api/drift/metrics');
            
            if (!metrics) {
                container.innerHTML = '<div class="error">Failed to load drift metrics. Make sure the API is running.</div>';
                return;
            }
            
            const cards = [];
            const windowSize = metrics.sample_size || 0;
            const totalQueries = metrics.total_queries || 0;
            const sampleInfo = windowSize > 0 
                ? `Window: ${windowSize} queries (Total: ${totalQueries.toLocaleString()})`
                : `Total queries: ${totalQueries.toLocaleString()}`;
            
            if (metrics.psi_score !== null && metrics.psi_score !== undefined) {
                const severity = metrics.psi_score < 0.15 ? 'normal' : 
                                metrics.psi_score < 0.25 ? 'warning' : 
                                metrics.psi_score < 0.40 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Population Stability Index (PSI)',
                    formatMetricValue(metrics.psi_score, 'psi_score'),
                    severity,
                    sampleInfo,
                    (metrics.psi_score / 0.4) * 100,
                    'psi_score'
                ));
            }
            
            if (metrics.ks_p_value !== null && metrics.ks_p_value !== undefined) {
                const severity = metrics.ks_p_value > 0.05 ? 'normal' : 
                                metrics.ks_p_value > 0.01 ? 'warning' : 
                                metrics.ks_p_value > 0.001 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Kolmogorov-Smirnov Test',
                    formatMetricValue(metrics.ks_p_value, 'ks_p_value'),
                    severity,
                    `Statistic: ${formatMetricValue(metrics.ks_statistic, 'ks_statistic')}`,
                    0,
                    'ks_p_value'
                ));
            }
            
            if (metrics.js_divergence !== null && metrics.js_divergence !== undefined) {
                const severity = metrics.js_divergence < 0.1 ? 'normal' : 
                                metrics.js_divergence < 0.2 ? 'warning' : 
                                metrics.js_divergence < 0.3 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Jensen-Shannon Divergence',
                    formatMetricValue(metrics.js_divergence, 'js_divergence'),
                    severity,
                    '',
                    (metrics.js_divergence / 0.3) * 100,
                    'js_divergence'
                ));
            }
            
            if (cards.length === 0) {
                const noDataMsg = totalQueries === 0 
                    ? '<div class="error">No data available. Run <code>python scripts/generate_sample_data.py</code> to generate sample data.</div>'
                    : '<div class="error">No metrics available. Generate sample data first.</div>';
                container.innerHTML = noDataMsg;
            } else {
                container.innerHTML = `<div class="metrics-grid">${cards.join('')}</div>`;
            }
            
            loadDriftChart();
            loadAlertChart();
            loadAlerts();
        }
        
        async function loadDriftChart() {
            const history = await fetchAPI('/api/drift/history?limit=50');
            
            if (!history || history.length === 0) {
                document.getElementById('driftChart').innerHTML = '<div class="loading">No historical data</div>';
                return;
            }
            
            const data = history.reverse();
            const timestamps = data.map(m => new Date(m.timestamp));
            
            const traces = [
                {
                    x: timestamps,
                    y: data.map(m => m.psi_score),
                    name: 'PSI Score',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#73BF69', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: timestamps,
                    y: data.map(m => m.js_divergence),
                    name: 'JS Divergence',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: '#5b9bd5', width: 2 },
                    marker: { size: 6 }
                }
            ];
            
            // Add threshold lines
            const shapes = [
                { type: 'line', y0: 0.15, y1: 0.15, x0: timestamps[0], x1: timestamps[timestamps.length-1], line: { color: '#F79420', dash: 'dash', width: 1 } },
                { type: 'line', y0: 0.25, y1: 0.25, x0: timestamps[0], x1: timestamps[timestamps.length-1], line: { color: '#E24D42', dash: 'dash', width: 1 } },
                { type: 'line', y0: 0.40, y1: 0.40, x0: timestamps[0], x1: timestamps[timestamps.length-1], line: { color: '#8B0000', dash: 'dash', width: 1 } }
            ];
            
            const layout = {
                paper_bgcolor: '#1a1a1a',
                plot_bgcolor: '#1a1a1a',
                font: { color: '#e0e0e0' },
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { gridcolor: '#2a2a2a', tickformat: '%m/%d %H:%M' },
                yaxis: { gridcolor: '#2a2a2a', title: 'Score' },
                legend: { orientation: 'h', y: -0.2 },
                shapes: shapes,
                annotations: [
                    { x: timestamps[timestamps.length-1], y: 0.15, text: 'Warning', showarrow: false, xanchor: 'left', font: { color: '#F79420', size: 10 } },
                    { x: timestamps[timestamps.length-1], y: 0.25, text: 'Critical', showarrow: false, xanchor: 'left', font: { color: '#E24D42', size: 10 } },
                    { x: timestamps[timestamps.length-1], y: 0.40, text: 'Emergency', showarrow: false, xanchor: 'left', font: { color: '#8B0000', size: 10 } }
                ]
            };
            
            Plotly.newPlot('driftChart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        async function loadAlertChart() {
            const alerts = await fetchAPI('/api/drift/alerts?status=all');
            
            if (!alerts || alerts.length === 0) {
                document.getElementById('alertChart').innerHTML = '<div class="loading">No alert history</div>';
                return;
            }
            
            // Count alerts by severity and date
            const alertsByDate = {};
            alerts.forEach(alert => {
                const date = new Date(alert.created_at).toLocaleDateString();
                if (!alertsByDate[date]) {
                    alertsByDate[date] = { warning: 0, critical: 0, emergency: 0 };
                }
                const severity = alert.severity.toLowerCase();
                if (alertsByDate[date][severity] !== undefined) {
                    alertsByDate[date][severity]++;
                }
            });
            
            const dates = Object.keys(alertsByDate).sort((a, b) => new Date(a) - new Date(b));
            
            const traces = [
                {
                    x: dates,
                    y: dates.map(d => alertsByDate[d].warning),
                    name: 'Warning',
                    type: 'bar',
                    marker: { color: '#F79420' }
                },
                {
                    x: dates,
                    y: dates.map(d => alertsByDate[d].critical),
                    name: 'Critical',
                    type: 'bar',
                    marker: { color: '#E24D42' }
                },
                {
                    x: dates,
                    y: dates.map(d => alertsByDate[d].emergency),
                    name: 'Emergency',
                    type: 'bar',
                    marker: { color: '#8B0000' }
                }
            ];
            
            const layout = {
                paper_bgcolor: '#1a1a1a',
                plot_bgcolor: '#1a1a1a',
                font: { color: '#e0e0e0' },
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { gridcolor: '#2a2a2a' },
                yaxis: { gridcolor: '#2a2a2a', title: 'Alert Count' },
                barmode: 'stack',
                legend: { orientation: 'h', y: -0.2 }
            };
            
            Plotly.newPlot('alertChart', traces, layout, { responsive: true, displayModeBar: false });
        }
        
        async function loadAlerts() {
            const container = document.getElementById('alertsContainer');
            const alerts = await fetchAPI('/api/drift/alerts?status=active');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; color: #B7B7B7;">No active alerts - System is healthy</div>';
                return;
            }
            
            // Count by severity
            const counts = { warning: 0, critical: 0, emergency: 0 };
            alerts.forEach(a => {
                const sev = a.severity.toLowerCase();
                if (counts[sev] !== undefined) counts[sev]++;
            });
            
            const summaryHtml = `
                <div class="alerts-summary">
                    ${counts.emergency > 0 ? `<span class="alert-count-badge emergency">${counts.emergency} Emergency</span>` : ''}
                    ${counts.critical > 0 ? `<span class="alert-count-badge critical">${counts.critical} Critical</span>` : ''}
                    ${counts.warning > 0 ? `<span class="alert-count-badge warning">${counts.warning} Warning</span>` : ''}
                </div>
            `;
            
            const alertsHtml = alerts.slice(0, 10).map(alert => {
                const severityClass = getSeverityClass(alert.severity);
                const overThreshold = alert.metric_value > alert.threshold_value ? 
                    ((alert.metric_value - alert.threshold_value) / alert.threshold_value * 100).toFixed(1) : 
                    ((alert.threshold_value - alert.metric_value) / alert.threshold_value * 100).toFixed(1);
                
                return `
                    <div class="alert-panel alert-${severityClass}">
                        <div class="alert-title">${alert.metric_name} - ${alert.severity.toUpperCase()}</div>
                        <div class="alert-details">
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Current value:</span>
                                <span class="alert-detail-value">${alert.metric_value.toFixed(4)}</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Threshold:</span>
                                <span class="alert-detail-value">${alert.threshold_value.toFixed(4)}</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Difference:</span>
                                <span class="alert-detail-value">${overThreshold}% ${alert.metric_value > alert.threshold_value ? 'above' : 'below'} threshold</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Created:</span>
                                <span class="alert-detail-value">${new Date(alert.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<h2>Active Alerts (${alerts.length})</h2>${summaryHtml}${alertsHtml}`;
        }
        
        async function loadRollbackInfo() {
            const container = document.getElementById('rollbackContainer');
            container.innerHTML = '<div class="loading">Loading rollback information...</div>';
            
            const [versions, history, current] = await Promise.all([
                fetchAPI('/api/rollback/versions'),
                fetchAPI('/api/rollback/history?limit=10'),
                fetchAPI('/api/rollback/current-config')
            ]);
            
            let html = '<h2>Rollback Control</h2>';
            
            html += '<div class="metrics-grid">';
            
            if (current) {
                html += `<div class="metric-card">
                    <div class="metric-label">Current Configuration</div>
                    <div class="metric-value">${current.version_label || 'v' + (current.version_id || 'N/A')}</div>
                    <div class="metric-status">Active since: ${current.created_at ? new Date(current.created_at).toLocaleString() : 'N/A'}</div>
                </div>`;
            }
            
            if (versions && versions.length > 0) {
                const knownGood = versions.filter(v => v.is_known_good).length;
                html += `<div class="metric-card">
                    <div class="metric-label">Available Versions</div>
                    <div class="metric-value">${versions.length}</div>
                    <div class="metric-status">${knownGood} known-good versions</div>
                </div>`;
            }
            
            html += '</div>';
            
            if (history && history.length > 0) {
                html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Rollback Timeline</h3>';
                html += history.map(event => `
                    <div class="timeline-event rollback">
                        <div class="timeline-time">${new Date(event.created_at).toLocaleString()}</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Rollback to Version ${event.target_version_id}</div>
                            <div class="timeline-desc">
                                Trigger: ${event.trigger_type} | Status: ${event.status}
                                ${event.trigger_reason ? `<br>${event.trigger_reason}` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                html += '<div style="padding: 1rem; color: #B7B7B7;">No rollback history</div>';
            }
            
            container.innerHTML = html;
        }
        
        async function loadOverview() {
            const container = document.getElementById('overviewContainer');
            container.innerHTML = '<div class="loading">Loading system overview...</div>';
            
            const [metrics, alerts, history] = await Promise.all([
                fetchAPI('/api/drift/metrics'),
                fetchAPI('/api/drift/alerts?status=active'),
                fetchAPI('/api/rollback/history?limit=5')
            ]);
            
            let html = '<h2>System Overview</h2>';
            html += '<div class="metrics-grid">';
            
            if (metrics) {
                const status = (alerts && alerts.length > 0) ? 
                    (alerts.some(a => a.severity.toLowerCase() === 'emergency') ? 'emergency' :
                     alerts.some(a => a.severity.toLowerCase() === 'critical') ? 'critical' : 'warning') : 'normal';
                
                html += `<div class="metric-card ${status}">
                    <div class="metric-label">System Status</div>
                    <div class="metric-value">${status === 'normal' ? 'Healthy' : status.charAt(0).toUpperCase() + status.slice(1)}</div>
                    <div class="metric-status">${alerts ? alerts.length : 0} active alerts</div>
                </div>`;
                
                html += `<div class="metric-card">
                    <div class="metric-label">Total Queries Processed</div>
                    <div class="metric-value">${(metrics.total_queries || 0).toLocaleString()}</div>
                    <div class="metric-status">Since deployment</div>
                </div>`;
                
                html += `<div class="metric-card">
                    <div class="metric-label">Last Updated</div>
                    <div class="metric-value">${new Date(metrics.timestamp).toLocaleTimeString()}</div>
                    <div class="metric-status">${new Date(metrics.timestamp).toLocaleDateString()}</div>
                </div>`;
            }
            
            html += '</div>';
            
            // System timeline
            html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Activity</h3>';
            
            const events = [];
            
            if (alerts) {
                alerts.slice(0, 5).forEach(a => {
                    events.push({
                        time: new Date(a.created_at),
                        type: a.severity.toLowerCase(),
                        title: `${a.severity} Alert: ${a.metric_name}`,
                        desc: `Value: ${a.metric_value.toFixed(4)} (threshold: ${a.threshold_value.toFixed(4)})`
                    });
                });
            }
            
            if (history) {
                history.forEach(r => {
                    events.push({
                        time: new Date(r.created_at),
                        type: 'rollback',
                        title: `Rollback Executed`,
                        desc: `Restored to version ${r.target_version_id} - ${r.trigger_type}`
                    });
                });
            }
            
            events.sort((a, b) => b.time - a.time);
            
            if (events.length > 0) {
                html += events.slice(0, 8).map(e => `
                    <div class="timeline-event ${e.type}">
                        <div class="timeline-time">${e.time.toLocaleString()}</div>
                        <div class="timeline-content">
                            <div class="timeline-title">${e.title}</div>
                            <div class="timeline-desc">${e.desc}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                html += '<div style="padding: 1rem; color: #B7B7B7;">No recent activity</div>';
            }
            
            container.innerHTML = html;
        }
        
        async function loadData() {
            await checkApiHealth();
            
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab.id === 'driftTab') {
                await loadDriftMetrics();
            } else if (activeTab.id === 'rollbackTab') {
                await loadRollbackInfo();
            } else if (activeTab.id === 'overviewTab') {
                await loadOverview();
            }
        }
        
        // Initialize
        loadData();
        startAutoRefresh();
    </script>
</body>
</html>
