<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pipeline Resilience Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #2a2a2a;
            padding-bottom: 1rem;
            text-align: center;
        }
        
        h1 {
            color: #ffffff;
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #B7B7B7;
            font-size: 0.9rem;
        }
        
        .status-container {
            margin-top: 1rem;
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 0;
            margin-right: 8px;
            background: #73BF69;
        }
        
        .status-indicator.offline {
            background: #E24D42;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-left: 4px solid #73BF69;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.2s;
        }
        
        .metric-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .metric-card.warning {
            border-left-color: #F79420;
        }
        
        .metric-card.critical {
            border-left-color: #E24D42;
        }
        
        .metric-card.emergency {
            border-left-color: #8B0000;
        }
        
        .metric-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #73BF69;
            margin: 12px 0;
            line-height: 1.2;
        }
        
        .metric-card.warning .metric-value {
            color: #F79420;
        }
        
        .metric-card.critical .metric-value {
            color: #E24D42;
        }
        
        .metric-card.emergency .metric-value {
            color: #8B0000;
        }
        
        .metric-status {
            font-size: 12px;
            color: #B7B7B7;
            margin-top: 8px;
        }
        
        .progress-bar {
            margin-top: 12px;
            height: 4px;
            background: #1a1a1a;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #73BF69;
            transition: width 0.3s;
        }
        
        .metric-card.warning .progress-fill {
            background: #F79420;
        }
        
        .metric-card.critical .progress-fill {
            background: #E24D42;
        }
        
        .metric-card.emergency .progress-fill {
            background: #8B0000;
        }
        
        .alerts-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #2a2a2a;
        }
        
        .alerts-section h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .alert-expandable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .alert-expandable:hover {
            background: #2a2a2a;
        }
        
        .alert-details-expanded {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
        }
        
        .alert-detail-row {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .alert-detail-label {
            color: #B7B7B7;
            font-weight: 500;
        }
        
        .alert-detail-value {
            color: #e0e0e0;
            margin-left: 8px;
        }
        
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            cursor: pointer;
            color: #B7B7B7;
            font-size: 12px;
            border: 1px solid #404040;
            border-radius: 50%;
            text-align: center;
            line-height: 14px;
            vertical-align: middle;
        }
        
        .info-icon:hover {
            color: #ffffff;
            border-color: #73BF69;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-content {
            visibility: hidden;
            position: absolute;
            background: #2a2a2a;
            color: #e0e0e0;
            padding: 12px;
            border: 1px solid #404040;
            border-radius: 4px;
            z-index: 1000;
            width: 300px;
            font-size: 12px;
            line-height: 1.6;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip:hover .tooltip-content {
            visibility: visible;
        }
        
        .tooltip-content code {
            background: #1a1a1a;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
        }
        
        footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid #2a2a2a;
            text-align: center;
            color: #B7B7B7;
            font-size: 14px;
        }
        
        footer a {
            color: #73BF69;
            text-decoration: none;
            margin: 0 8px;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        .alert-panel {
            background: #1a1a1a;
            border-left: 4px solid;
            padding: 20px;
            margin: 12px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .alert-warning {
            border-left-color: #F79420;
        }
        
        .alert-critical {
            border-left-color: #E24D42;
        }
        
        .alert-emergency {
            border-left-color: #8B0000;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .alert-details {
            font-size: 14px;
            color: #B7B7B7;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #B7B7B7;
        }
        
        .error {
            background: #1a1a1a;
            border: 1px solid #E24D42;
            padding: 1rem;
            margin: 1rem 0;
            color: #E24D42;
        }
        
        .refresh-btn {
            background: #2a2a2a;
            color: white;
            border: 1px solid #404040;
            padding: 10px 20px;
            border-radius: 2px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .refresh-btn:hover {
            background: #3a3a3a;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #2a2a2a;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #B7B7B7;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #ffffff;
            border-bottom-color: #73BF69;
        }
        
        .tab:hover {
            color: #ffffff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Pipeline Resilience Dashboard</h1>
            <p class="subtitle">Drift Detection and Rollback System for Healthcare AI Pipelines</p>
            <div class="status-container">
                <span class="status-indicator" id="apiStatus"></span>
                <span id="apiStatusText">Checking API...</span>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('drift')">Drift Detection</div>
            <div class="tab" onclick="switchTab('rollback')">Rollback Control</div>
            <div class="tab" onclick="switchTab('overview')">System Overview</div>
        </div>
        
        <div id="driftTab" class="tab-content active">
            <div id="metricsContainer" class="loading">Loading metrics...</div>
            <div id="alertsContainer" class="alerts-section"></div>
        </div>
        
        <div id="rollbackTab" class="tab-content">
            <div id="rollbackContainer" class="loading">Loading rollback information...</div>
        </div>
        
        <div id="overviewTab" class="tab-content">
            <div id="overviewContainer" class="loading">Loading system overview...</div>
        </div>
        
        <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
        
        <footer>
            <a href="https://github.com/vasanthpanuganti/AI-voice-reliability-dashboard" target="_blank" rel="noopener noreferrer">GitHub</a>
            <span>•</span>
            <span>Built by curiosity</span>
        </footer>
    </div>
    
    <script>
        // Auto-detect API URL
        const API_BASE_URL = window.location.origin;
        let refreshInterval;
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load data for the active tab
            loadData();
        }
        
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                const statusEl = document.getElementById('apiStatus');
                const statusText = document.getElementById('apiStatusText');
                
                if (data.status === 'healthy') {
                    statusEl.classList.remove('offline');
                    statusText.textContent = 'API: Healthy';
                } else {
                    statusEl.classList.add('offline');
                    statusText.textContent = 'API: Offline';
                }
            } catch (error) {
                document.getElementById('apiStatus').classList.add('offline');
                document.getElementById('apiStatusText').textContent = 'API: Offline';
            }
        }
        
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }
        
        function getSeverityClass(severity) {
            const severityLower = severity?.toLowerCase() || 'normal';
            if (severityLower === 'warning') return 'warning';
            if (severityLower === 'critical') return 'critical';
            if (severityLower === 'emergency') return 'emergency';
            return '';
        }
        
        function formatMetricValue(value, metricType) {
            if (value === null || value === undefined) return 'N/A';
            if (metricType === 'psi_score' || metricType === 'js_divergence') {
                return value.toFixed(3);
            }
            if (metricType === 'ks_p_value') {
                return value.toExponential(2);
            }
            return value.toFixed(2);
        }
        
        function createMetricCard(label, value, severity, subtitle = '', progress = 0, metricType = '') {
            const severityClass = getSeverityClass(severity);
            const colorMap = {
                normal: '#73BF69',
                warning: '#F79420',
                critical: '#E24D42',
                emergency: '#8B0000'
            };
            const statusMap = {
                normal: 'All Good',
                warning: 'Needs Attention',
                critical: 'Action Required',
                emergency: 'Urgent Action'
            };
            
            const color = colorMap[severity?.toLowerCase() || 'normal'] || '#73BF69';
            const status = statusMap[severity?.toLowerCase() || 'normal'] || 'All Good';
            
            // Formula tooltips
            const formulas = {
                'psi_score': {
                    title: 'Population Stability Index (PSI)',
                    formula: 'PSI = Σ((Actual_i - Expected_i) × ln(Actual_i / Expected_i))',
                    description: 'Measures how much a distribution has shifted over time. Higher values indicate greater distribution change.'
                },
                'ks_p_value': {
                    title: 'Kolmogorov-Smirnov Test',
                    formula: 'D = max|F_n(x) - F_0(x)|',
                    description: 'Tests if two samples come from the same distribution. Lower p-values indicate distributions are more different.'
                },
                'js_divergence': {
                    title: 'Jensen-Shannon Divergence',
                    formula: 'JS(P||Q) = 0.5 × KL(P||M) + 0.5 × KL(Q||M) where M = 0.5(P+Q)',
                    description: 'Symmetric measure of similarity between probability distributions. Returns value between 0 (identical) and 1 (completely different).'
                },
                'wasserstein': {
                    title: 'Wasserstein Distance',
                    formula: 'W_p(P,Q) = (inf E[|X-Y|^p])^(1/p)',
                    description: 'Measures the minimum cost to transform one distribution into another. More sensitive to subtle semantic shifts.'
                }
            };
            
            const formulaInfo = formulas[metricType] || null;
            const infoButton = formulaInfo ? `
                <span class="tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                        <strong>${formulaInfo.title}</strong><br><br>
                        <strong>Formula:</strong><br>
                        <code>${formulaInfo.formula}</code><br><br>
                        <strong>Interpretation:</strong><br>
                        ${formulaInfo.description}
                    </span>
                </span>
            ` : '';
            
            return `
                <div class="metric-card ${severityClass}">
                    <div class="metric-label">${label}${infoButton}</div>
                    <div class="metric-value">${value}</div>
                    <div class="metric-status">${status}</div>
                    ${subtitle ? `<div class="metric-status">${subtitle}</div>` : ''}
                    ${progress > 0 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(100, progress)}%"></div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        async function loadDriftMetrics() {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '<div class="loading">Loading metrics...</div>';
            
            const metrics = await fetchAPI('/api/drift/metrics');
            
            if (!metrics) {
                container.innerHTML = '<div class="error">Failed to load drift metrics. Make sure the API is running.</div>';
                return;
            }
            
            const cards = [];
            
            // Display sample size info (window vs total)
            const windowSize = metrics.sample_size || 0;
            const totalQueries = metrics.total_queries || 0;
            const sampleInfo = windowSize > 0 
                ? `Window: ${windowSize} queries (Total: ${totalQueries.toLocaleString()})`
                : `Total queries: ${totalQueries.toLocaleString()}`;
            
            if (metrics.psi_score !== null && metrics.psi_score !== undefined) {
                const severity = metrics.psi_score < 0.15 ? 'normal' : 
                                metrics.psi_score < 0.25 ? 'warning' : 
                                metrics.psi_score < 0.40 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Population Stability Index (PSI)',
                    formatMetricValue(metrics.psi_score, 'psi_score'),
                    severity,
                    sampleInfo,
                    (metrics.psi_score / 0.4) * 100,
                    'psi_score'
                ));
            }
            
            if (metrics.ks_p_value !== null && metrics.ks_p_value !== undefined) {
                const severity = metrics.ks_p_value > 0.05 ? 'normal' : 
                                metrics.ks_p_value > 0.01 ? 'warning' : 
                                metrics.ks_p_value > 0.001 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Kolmogorov-Smirnov Test',
                    formatMetricValue(metrics.ks_p_value, 'ks_p_value'),
                    severity,
                    `Statistic: ${formatMetricValue(metrics.ks_statistic, 'ks_statistic')}`,
                    0,
                    'ks_p_value'
                ));
            }
            
            if (metrics.js_divergence !== null && metrics.js_divergence !== undefined) {
                const severity = metrics.js_divergence < 0.1 ? 'normal' : 
                                metrics.js_divergence < 0.2 ? 'warning' : 
                                metrics.js_divergence < 0.3 ? 'critical' : 'emergency';
                cards.push(createMetricCard(
                    'Jensen-Shannon Divergence',
                    formatMetricValue(metrics.js_divergence, 'js_divergence'),
                    severity,
                    '',
                    (metrics.js_divergence / 0.3) * 100,
                    'js_divergence'
                ));
            }
            
            if (cards.length === 0) {
                const noDataMsg = totalQueries === 0 
                    ? '<div class="error">No data available. Run <code>python scripts/generate_sample_data.py</code> to generate sample data.</div>'
                    : '<div class="error">No metrics available. Generate sample data first.</div>';
                container.innerHTML = noDataMsg;
            } else {
                container.innerHTML = `<div class="metrics-grid">${cards.join('')}</div>`;
            }
            
            // Load alerts
            loadAlerts();
        }
        
        async function loadAlerts() {
            const container = document.getElementById('alertsContainer');
            const alerts = await fetchAPI('/api/drift/alerts?status=active');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; color: #B7B7B7;">No active alerts</div>';
                return;
            }
            
            // Fetch detailed diagnostics for each alert
            const alertsWithDetails = await Promise.all(
                alerts.map(async (alert) => {
                    const diagnostics = await fetchAPI(`/api/drift/alerts/${alert.id}/diagnostics`);
                    return { alert, diagnostics };
                })
            );
            
            const alertsHtml = alertsWithDetails.map(({ alert, diagnostics }, index) => {
                const severityClass = getSeverityClass(alert.severity);
                const overThreshold = alert.metric_value > alert.threshold_value ? 
                    ((alert.metric_value - alert.threshold_value) / alert.threshold_value * 100).toFixed(1) : 
                    ((alert.threshold_value - alert.metric_value) / alert.threshold_value * 100).toFixed(1);
                
                let detailsHtml = '';
                if (diagnostics && diagnostics.diagnostics) {
                    const diag = diagnostics.diagnostics;
                    detailsHtml = `
                        <div class="alert-details-expanded">
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">What this means:</span>
                                <span class="alert-detail-value">${diag.what_it_means || diag.interpretation || 'N/A'}</span>
                            </div>
                            ${diag.baseline_period ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Baseline period:</span>
                                    <span class="alert-detail-value">${diag.baseline_period}</span>
                                </div>
                            ` : ''}
                            ${diag.current_period ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Current period:</span>
                                    <span class="alert-detail-value">${diag.current_period}</span>
                                </div>
                            ` : ''}
                            ${diag.baseline_sample_size ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Baseline sample size:</span>
                                    <span class="alert-detail-value">${diag.baseline_sample_size}</span>
                                </div>
                            ` : ''}
                            ${diag.current_sample_size ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Current sample size:</span>
                                    <span class="alert-detail-value">${diag.current_sample_size}</span>
                                </div>
                            ` : ''}
                            ${diag.category_shifts && diag.category_shifts.length > 0 ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Category shifts:</span>
                                    <span class="alert-detail-value">
                                        ${diag.category_shifts.map(cs => 
                                            `${cs.category}: ${cs.baseline_percentage}% → ${cs.current_percentage}% (${cs.shift > 0 ? '+' : ''}${cs.shift}%)`
                                        ).join(', ')}
                                    </span>
                                </div>
                            ` : ''}
                            ${diag.severity_interpretation ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Severity interpretation:</span>
                                    <span class="alert-detail-value">${diag.severity_interpretation}</span>
                                </div>
                            ` : ''}
                            ${diag.recommendations && diag.recommendations.length > 0 ? `
                                <div class="alert-detail-row">
                                    <span class="alert-detail-label">Recommendations:</span>
                                    <span class="alert-detail-value">
                                        <ul style="margin: 8px 0; padding-left: 20px;">
                                            ${diag.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                        </ul>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="alert-panel alert-${severityClass}">
                        <div class="alert-title">${alert.metric_name} - ${alert.severity.toUpperCase()}</div>
                        <div class="alert-details">
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Current value:</span>
                                <span class="alert-detail-value">${alert.metric_value.toFixed(3)}</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Threshold:</span>
                                <span class="alert-detail-value">${alert.threshold_value.toFixed(3)}</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Difference:</span>
                                <span class="alert-detail-value">${overThreshold}% ${alert.metric_value > alert.threshold_value ? 'above' : 'below'} threshold</span>
                            </div>
                            <div class="alert-detail-row">
                                <span class="alert-detail-label">Created:</span>
                                <span class="alert-detail-value">${new Date(alert.created_at).toLocaleString()}</span>
                            </div>
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<h2>Active Alerts</h2>${alertsHtml}`;
        }
        
        async function loadRollbackInfo() {
            const container = document.getElementById('rollbackContainer');
            container.innerHTML = '<div class="loading">Loading rollback information...</div>';
            
            const [versions, history, current] = await Promise.all([
                fetchAPI('/api/rollback/versions'),
                fetchAPI('/api/rollback/history?limit=10'),
                fetchAPI('/api/rollback/current-config')
            ]);
            
            let html = '<h2>Rollback Control</h2>';
            
            if (current) {
                html += `<div class="metric-card" style="margin-bottom: 2rem;">
                    <div class="metric-label">Current Configuration</div>
                    <div class="metric-value">Version ${current.version_id || 'N/A'}</div>
                    <div class="metric-status">Created: ${current.created_at ? new Date(current.created_at).toLocaleString() : 'N/A'}</div>
                </div>`;
            }
            
            if (history && history.length > 0) {
                html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Rollback History</h3>';
                html += history.map(event => `
                    <div class="alert-panel">
                        <div class="alert-title">Rollback to Version ${event.target_version_id}</div>
                        <div class="alert-details">
                            Trigger: ${event.trigger_type} | Status: ${event.status} | 
                            ${new Date(event.created_at).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            } else {
                html += '<div style="padding: 1rem; color: #B7B7B7;">No rollback history</div>';
            }
            
            container.innerHTML = html;
        }
        
        async function loadOverview() {
            const container = document.getElementById('overviewContainer');
            container.innerHTML = '<div class="loading">Loading system overview...</div>';
            
            const [metrics, alerts] = await Promise.all([
                fetchAPI('/api/drift/metrics'),
                fetchAPI('/api/drift/alerts?status=active')
            ]);
            
            let html = '<h2>System Overview</h2>';
            
            if (metrics) {
                html += `<div class="metric-card" style="margin-bottom: 1rem;">
                    <div class="metric-label">Last Metrics Update</div>
                    <div class="metric-value">${new Date(metrics.timestamp).toLocaleString()}</div>
                    <div class="metric-status">Sample Size: ${metrics.sample_size || 0}</div>
                </div>`;
            }
            
            if (alerts) {
                html += `<div class="metric-card ${alerts.length > 0 ? 'warning' : ''}" style="margin-bottom: 1rem;">
                    <div class="metric-label">Active Alerts</div>
                    <div class="metric-value">${alerts.length}</div>
                    <div class="metric-status">${alerts.length === 0 ? 'No issues detected' : 'Action required'}</div>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        async function loadData() {
            await checkApiHealth();
            
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab.id === 'driftTab') {
                await loadDriftMetrics();
            } else if (activeTab.id === 'rollbackTab') {
                await loadRollbackInfo();
            } else if (activeTab.id === 'overviewTab') {
                await loadOverview();
            }
        }
        
        // Initialize
        loadData();
        
        // Auto-refresh every 30 seconds
        refreshInterval = setInterval(loadData, 30000);
    </script>
</body>
</html>
